---
title: "COVID-19"
description: |
  Website para predicciones de muertes y hospitalizaciones por COVID-19 en México
site: distill::distill_website
output: 
  distill::distill_article:
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(ggnewscale)
library(ggpubr)

# source("index_prep.R")
load("data/index_data.RData")
```


```{r, message=FALSE, warning=FALSE, layout="l-page", results='asis', fig.width=14, fig.height=10}
cat(glue::glue('\n\n# Indicadores por entidad federativa  \n\n'))
max_date <- deaths_df %>% 
    filter(!is.na(y)) %>% 
    select(date) %>% 
    pull %>% 
    max + 0.5

cat(glue::glue('\n\nDatos hasta el día: {max_date} y predicciones para {fc} días más \n\n'))
################################################################################
#################################  PLOTTING  ###################################
################################################################################
# countries = countries[1]
for (c in countries){
  
  country = df_region_codes[which(df_region_codes[,2]==c),1]
  cat(glue::glue('\n\n## {country} \n\n'))
  
  df1 <- pred_df_long %>% filter(country == c)
  df1$credibility <- factor(df1$credibility, levels=c('95%', '50%'))
  
  df2 <- deaths_df %>% filter(country == c)
  df2$status <- factor(df2$status, levels=c('Suspected', 'Confirmed'))
  
  df3 <- hosp_df %>% filter(country == c)
  df3$status <- factor(df3$status, levels=c('Suspected', 'Confirmed'))
  
  
  p1 <- ggplot(data = df1 %>% filter(var == 'E_deaths'),
                 aes(x=date)) +
    theme_classic() +
  # p1 <- p1 +
    geom_bar(data = df2,
             aes(x=date,
                 y=y,
                 fill=as.factor(status)),
             stat = 'identity',
             alpha=0.6) +
             # color = '#878787') +
    scale_fill_manual(name = "SARS-CoV-2:",
                      values = rev(c('gold', 'red')),
                      breaks = rev(c("Suspected", "Confirmed")),
                      labels = rev(c('Sospechoso', 'Positivo')),
                      limits = rev(levels(df2$status)),
                      guide_legend(reverse=T)) +
    new_scale('fill') +
    geom_ribbon(
      aes(ymin = y_li, 
          ymax = y_ui,
          fill = credibility)) +
    scale_fill_manual(name = "Credibilidad:",
                      values = c(alpha("deepskyblue4", 0.40),
                                 alpha("deepskyblue4", 0.60)),
                      guide_legend(reverse=T)) +
    geom_vline(xintercept = max_date, 
               col = "black", 
               linetype = "dashed",
               alpha = 0.5) + 
    geom_line(
      aes(y = y),
      color = 'deepskyblue4') +
    xlab("") +
    ylab("Muertes diarias") + 
    labs(
      title ='Muertes diarias por SARS-CoV-2',
      subtitle = glue::glue('{country}')
      ) +
    scale_x_date(date_labels = "%e %b",
                 date_breaks = "1 week",
                 expand = c(0,0)) +
    scale_y_continuous(labels = scales::comma_format(accuracy = 1),
                       n.breaks = 10)+
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "right",
      panel.grid.major.x = element_line(
        linetype = "dotted",
        colour = "gray"),
      panel.grid.major.y = element_line(
        linetype = "dotted",
        colour = "gray"),
    ) + 
    coord_cartesian(expand = FALSE)
  
    
    
  p2 <- ggplot(data = df1 %>% filter(var == 'E_hosp'),
               aes(x=date)) +
    theme_classic() +
    # p1 <- p1 +
    geom_bar(data = df3,
             aes(x=date,
                 y=y,
                 fill=as.factor(status)),
             stat = 'identity',
             alpha=0.6) +
             # color = '#878787') +
    scale_fill_manual(name = "SARS-CoV-2:",
                      values = rev(c('gold', 'darkgreen')),
                      breaks = rev(c("Suspected", "Confirmed")),
                      labels = rev(c('Sospechoso', 'Positivo')),
                      limits = rev(levels(df2$status)),
                      guide_legend(reverse=T)) +
    new_scale('fill') +
    geom_ribbon(
      aes(ymin = y_li, 
          ymax = y_ui,
          fill = credibility)) +
    scale_fill_manual(name = "Credibilidad:",
                      values = c(alpha("deepskyblue4", 0.40),
                                 alpha("deepskyblue4", 0.60)),
                      guide_legend(reverse=T)) +
    geom_vline(xintercept = max_date, 
               col = "black", 
               linetype = "dashed",
               alpha = 0.5) + 
    geom_line(
      aes(y = y),
      color = 'deepskyblue4') +
    xlab("") +
    ylab("Hospitalizaciones") + 
    labs(
      title ='Hospitalizaciones diarias por SARS-CoV-2',
      subtitle = glue::glue('{country}')
    ) +
    scale_x_date(date_labels = "%e %b",
                 date_breaks = "1 week",
                 expand = c(0,0)) +
    scale_y_continuous(labels = scales::comma_format(accuracy = 1),
                       n.breaks = 10)+
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "right",
      panel.grid.major.x = element_line(
        linetype = "dotted",
        colour = "gray"),
      panel.grid.major.y = element_line(
        linetype = "dotted",
        colour = "gray"),
    ) + 
    coord_cartesian(expand = FALSE)
    
  p3 <- ggplot(data = df1 %>% filter(var == "Rt_adj"),
               aes(x=date)) +
    theme_classic() +
    # p1 <- p1 +
    geom_ribbon(
      aes(ymin = y_li, 
          ymax = y_ui,
          fill = credibility)) +
    scale_fill_manual(name = "Credibilidad:",
                      values = c(alpha("deepskyblue4", 0.40),
                                 alpha("deepskyblue4", 0.60)),
                      guide_legend(reverse=T)) +
    geom_vline(xintercept = max_date, 
               col = "black", 
               linetype = "dashed",
               alpha = 0.5) + 
    geom_hline(yintercept = 1.0, 
               col = "black", 
               linetype = "solid",
               alpha = 0.6) + 
    geom_line(
      aes(y = y),
      color = 'deepskyblue4') +
    xlab("") +
    ylab(expression(R[t]^{adj})) +
    labs(
      title ='Número de reproducción ajustado',
      subtitle = glue::glue('{country}')
    ) +
    scale_x_date(date_labels = "%e %b",
                 date_breaks = "1 week",
                 expand = c(0,0)) +
    scale_y_continuous(labels = scales::comma_format(accuracy = 0.1),
                       n.breaks = 10)+
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "right",
      panel.grid.major.x = element_line(
        linetype = "dotted",
        colour = "gray"),
      panel.grid.major.y = element_line(
        linetype = "dotted",
        colour = "gray"),
    ) + 
    coord_cartesian(expand = FALSE)
  
  
  p4 <- ggplot(data = df1 %>% filter(var == "prediction"),
               aes(x=date)) +
    theme_classic() +
    # p1 <- p1 +
    geom_ribbon(
      aes(ymin = y_li, 
          ymax = y_ui,
          fill = credibility)) +
    scale_fill_manual(name = "Credibilidad:",
                      values = c(alpha("darkred", 0.40),
                                 alpha("darkred", 0.60)),
                      guide_legend(reverse=T)) +
    geom_vline(xintercept = max_date, 
               col = "black", 
               linetype = "dashed",
               alpha = 0.5) + 
    geom_line(
      aes(y = y),
      color = 'darkred') +
    xlab("") +
    ylab('Nuevas infecciones') +
    labs(
      title ='Infecciones de SARS-CoV-2 diarias',
      subtitle = glue::glue('{country}')
    ) +
    scale_x_date(date_labels = "%e %b",
                 date_breaks = "1 week",
                 expand = c(0,0)) +
    scale_y_continuous(labels = scales::comma_format(accuracy = 1),
                       n.breaks = 10)+
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "right",
      panel.grid.major.x = element_line(
        linetype = "dotted",
        colour = "gray"),
      panel.grid.major.y = element_line(
        linetype = "dotted",
        colour = "gray"),
    ) + 
    coord_cartesian(expand = FALSE)
  
  # print(p1)
  # cat('\n\n')
  # print(p2)
  # cat('\n\n')
  # print(p3)
  # cat('\n\n')
  # print(p4)
  # cat('\n\n')
  
  cat('\n\n')
  p <- cowplot::plot_grid(p1, p2, p3, p4, ncol = 2, nrow=2)
  print(p)
  cat('\n\n')

}


```
















